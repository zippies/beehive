{% extends "base.html" %}

{% block title %}
    missions
{% endblock %}

{% block csssrc %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap-progressbar-3.2.0.min.css">
    <style>
        .panelstyle{
            font-size:12px;
            color:#CD3700;
        }
        .apipanel {
            margin-bottom:10px;
            padding-top:10px;
            -webkit-border-radius: 8px;
            -moz-border-radius: 8px;
            border-radius: 8px; 
            -webkit-box-shadow: #666 0px 0px 3px; 
            -moz-box-shadow: #666 0px 0px 3px; 
            box-shadow: #666 0px 0px 3px;
        }
    </style>
{% endblock %}


{% block container %}

    <form action="/newmission" id="newmissionform" method="post" enctype="multipart/form-data">
        <div>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <span class="panelstyle">Step 01: Mission Name</span>
                </div>
            </div>
            <div class="lineitem">
                <input class="form-control required" id="missionName" type="text" name="missionName" value="Mission_{{ timenow }}">
            </div>
        </div>
        <div>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <span class="panelstyle">Step 02: Basic Test Config</span>
                </div>
            </div>
            <div class="row clearfix">
                <div class="col-md-12 column" id="apilistdiv">
                    <div class="col-md-1" style="padding-right:3px">
                        <div class="list-group" id="apilist" style="text-align:center">
                            <a href="javascript:;" id="apilist-1" class="list-group-item active" onclick="showapiconfig(1)">接口_1</a>
                        </div>
                        <div style="text-align:center">
                            <a href="javascript:;" onclick="addApi()"><span class="glyphicon glyphicon-plus"></span> 添加</a>
                        </div>
                    </div>

                    {{ api_1|safe }}
                </div>
            </div>
        </div>

        <div>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <span class="panelstyle">Step 03: Choise Avaliable Machines</span>
                </div>
            </div>
            <div id="machinelistdiv" class="row" style="padding:10px">
            </div>
        </div>

        <div>
            <div class="panel panel-info" id="runtimeConfig">
                <div class="panel-heading">
                    <span class="panelstyle">Step 04: Runtime Configs</span>
                </div>
            </div>
            <div class="lineitem">
                <ul class="list-inline">
                    <li><label><span style="color:red">*</span>并发量：</label><input id="concurrent" name="concurrent" type="text" value="1" class="required"> <label><span style="color:red">*</span>持续时间：</label><input id="looptime" class="required" name="looptime" value="10" type="text"></li>
                    <li>
                        <label class="radio-inline">
                          <input type="radio" name="looptimeOptions" value="0" checked="checked">秒
                        </label>
                        <label class="radio-inline">
                          <input type="radio" name="looptimeOptions" value="1">分
                        </label>
                        <label class="radio-inline">
                          <input type="radio" name="looptimeOptions" value="2">时
                        </label>
                    </li>
                    <li><label>启动延迟：</label><input name="startDelay" type="text"> 秒</li>
                    <li><label>分析蜂数：</label><input type="text" name="beecount"></li>
                </ul>

                <ul class="list-inline">
                    <li><a class="btn btn-info" id="startbtn">开始压测</a></li>
                    <li><a class="btn btn-danger" id="stopbtn">停止任务</a></li>
                    <li><a class="btn btn-warning" id="clearbtn">清除数据</a></li>
                </ul>

            </div>
        </div>
    </form>

    <hr>

    <div>
        <div class="progress progress-striped active" id="progressdiv" style="display:none">
            <div id="progressbar" class="progress-bar progress-bar-warning" role="progressbar" aria-valuemax="4" data-transitiongoal="1"></div>
        </div>
        <div id="initialdetail" style="display:none;text-align:center">
            正在<span id="initialstate">解析mission配置</span>...
        </div>

        <div>
            <label>状态：</label><button class="btn btn-warning btn-xs" id="runningstate">未启动</button> <label> time elapsed: </label><span id="elapsed">0</span> / <span id="looptime-state">0</span>
        </div>

        <div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>label</th>
                        <th>样本量</th>
                        <th>最小响应时间</th>
                        <th>最大响应时间</th>
                        <th>平均响应时间</th>
                        <th>吞吐量</th>
                        <th>错误数</th>
                        <th>错误百分比</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>总体</td>
                        <td id="samples">0</td>
                        <td id="min-time">0</td>
                        <td id="max-time">0</td>
                        <td id="avg-time">0</td>
                        <td id="throught">0</td>
                        <td id="errors">0</td>
                        <td id="error-percent">0</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="height:600px" class="col-lg-12">
            <div class="col-lg-6" id="errordiv" style="height:100%"></div>
            <div class="col-lg-6" id="elapsediv" style="height:100%"></div>
        </div>

    </div>
{% endblock %}

{% block script %}
    {{ super() }}
    <script src="/static/js/bootstrap-progressbar.min.js"></script>
    <script src="/static/js/echarts.common.min.js"></script>
<script>

    $(function(){
        $("#helponenv").popover({html:true})
        $("#helponfile").popover({html:true})
        sessionStorage.clear()
        sessionStorage.choicedMachine = parseInt(0)
        sessionStorage.apicount = parseInt(1)
        getMachines();
        freshStatus();
        
        $("#clearbtn").click(clearResult)

        $("#startbtn").click(function(){

            if(!validateForm()){
                return
            }
            
            if(!localStorage.runningjob){

                clearResult();

                var formdata = new FormData($("#newmissionform")[0])
                $.ajax({
                    url:"/newmission",
                    type:"POST",
                    data:formdata,
                    dataType:"JSON",
                    cache:false,
                    processData:false,
                    contentType:false,
                    error:function(request){
                        layer.msg(request.status)
                        localStorage.clear();
                    },
                    success:function(data){
                        if(data.result){
                            localStorage.runningjob = data.missionid;
                            freshStatus()
                            console.log("fresh end")
                        }else{
                            layer.msg("运行失败:"+data.errorMsg)
                        }
                    }
                })
            }else{
                $("html,body").animate({scrollTop:$("#runtimeConfig").offset().top},1000)
            }
        })


        $("#stopbtn").click(function(){
            $.ajax({
                url:"/stopmission/"+localStorage.runningjob,
                type:"post",
                error:function(request){
                    layer.msg(request.status)
                    console.log(request.status)
                },
                success:function(data){
                    if(data.result){
                        layer.msg("停止成功")
                        console.log("停止成功")
                    }else{
                        layer.msg("停止失败:"+data.errorMsg)
                        console.log("停止失败:"+data.errorMsg)
                    }
                }
            })
        })
    })

    function addenv(apiid){
        if(eval("sessionStorage.envcount_"+apiid+"")){
            eval("sessionStorage.envcount_"+apiid+" = parseInt(sessionStorage.envcount_"+apiid+") + 1")
        }else{
            eval("sessionStorage.envcount_"+apiid+" = 1")
        }
        envid = eval("sessionStorage.envcount_"+apiid+"")

        $("#envlist-"+apiid).append("<div id='env-"+apiid+"-"+envid+"'><input type='checkbox' name='env-"+apiid+"' style='display:none' checked='checked'>匹配自: <label><input type='radio' name='envsource-"+apiid+"-"+envid+"' value='header'> 响应头</label> <label><input type='radio' name='envsource-"+apiid+"-"+envid+"' value='body' checked='checked'> 响应体</label> <input type='text' placeholder='正则匹配表达式'  class='required' name='envregx-"+apiid+"-"+envid+"'> <input type='text' class='required' name='envname-"+apiid+"-"+envid+"' placeholder='将匹配值保存为变量名'> <a href='javascript:;' onclick='delenv("+apiid+","+envid+")'>删除</a></div>")
    }

    function delenv(apiid,envid){
        $("#env-"+apiid+"-"+envid).remove()
        eval("sessionStorage.envcount_"+apiid+" = parseInt(sessionStorage.envcount_"+apiid+") - 1")
    }

    function clearResult(){
        localStorage.clear()
        $("#elapsed").html(0)
        $("#looptime-state").html(0)
        $("#samples").html(0)
        $("#min-time").html(0)
        $("#max-time").html(0)
        $("#avg-time").html(0)
        $("#throught").html(0)
        $("#errors").html(0)
        $("#error-percent").html(0)
        $("#errordiv").empty()
        $("#elapsediv").empty()
        $("#progressdiv").hide()
        $("#initialdetail").hide()
        $("#runningstate").removeClass("btn-success").removeClass("btn-danger").addClass("btn-warning").html("未启动")
        $("#progressbar").removeClass("progress-bar-success").removeClass("progress-bar-danger").addClass("progress-bar-warning")
    }

    function freshStatus(){
        if(localStorage.runningjob){
            $("#progressdiv").show()
            $("html,body").animate({scrollTop:$("#runtimeConfig").offset().top},1000)
            var interval = window.setInterval(function(){
                $.ajax({
                    url:"/freshstatus/"+localStorage.runningjob,
                    type:"get",
                    error:function(request){
                        layer.msg(request.status)
                        window.clearInterval(interval)
                    },
                    success:function(data){
                        resp = JSON.parse(data)
                        console.log(resp,resp.s)
                        if(resp.s == -1){
                            window.clearInterval(interval)
                            $("#progressbar").removeClass("progress-bar-warning").addClass("progress-bar-danger");
                            $("#initialdetail").hide();
                            $("#runningstate").removeClass("btn-success").removeClass("btn-warning").addClass("btn-danger").html("启动失败");
                            layer.msg(resp.i);
                            return
                        }
                        if(resp.s != 0){
                            if(resp.s  == 1){
                                $("#progressbar").removeClass("progress-bar-warning").addClass("progress-bar-danger").attr("aria-valuemax",resp.l).attr("data-transitiongoal",resp.p);
                                $("#runningstate").removeClass("btn-warning").removeClass("btn-success").addClass("btn-danger").html("正在压测");
                            }else{
                                console.log("finished here")
                                $("#progressbar").removeClass("progress-bar-warning").removeClass("progress-bar-danger").addClass("progress-bar-success").attr("aria-valuemax",resp.l).attr("data-transitiongoal",resp.p);
                                $("#runningstate").removeClass("btn-danger").removeClass("btn-warning").addClass("btn-success").html("压测完成");

                                var errorChart = echarts.init(document.getElementById('errordiv'));
                                var elapseChart = echarts.init(document.getElementById('elapsediv'));

                                $.ajax({
                                    url:"/getErrorChart/"+localStorage.runningjob,
                                    type:"get",
                                    error:function(request){
                                        layer.msg(request.status)
                                    },
                                    success:function(data){
                                        errorChart.setOption(data);
                                    }
                                })

                                $.ajax({
                                    url:"/getElapseChart/"+localStorage.runningjob,
                                    type:"get",
                                    error:function(request){
                                        layer.msg(request.status)
                                    },
                                    success:function(data){
                                        elapseChart.setOption(data);
                                    }
                                })

                                localStorage.clear();
                                window.clearInterval(interval);
                            }
                            $("#initialdetail").hide()
                            $('.progress .progress-bar').progressbar({display_text: 'center', use_percentage: false, amount_format: function(p, t) {return p + ' / ' + t;}});
                            $("#elapsed").html(resp.e)
                            $("#looptime-state").html(resp.l)
                            $("#samples").html(resp.sas)
                            $("#min-time").html(resp.min_e)
                            $("#max-time").html(resp.max_e)
                            $("#avg-time").html(resp.avg_e)
                            $("#throught").html(resp.toh)
                            $("#errors").html(resp.es)
                            $("#error-percent").html(resp.e_p)
                            $("#error_conn").html(resp.e_c)
                            $("#error_resp").html(resp.e_r)
                            $("#error_unknown").html(resp.e_u)
                            $("#error_assert").html(resp.e_a)
                        }else{
                            $("#initialdetail").show();
                            $("#progressbar").attr("data-transitiongoal",resp.p);
                            $('.progress .progress-bar').progressbar({display_text: 'center', use_percentage: false, amount_format: function(p, t) {return p + ' / ' + t;}});
                            $("#initialstate").html(resp.i)
                            $("#runningstate").removeClass("btn-success").removeClass("btn-danger").addClass("btn-warning").html("初始化mission配置")
                        }
                    }
                })
            },3000)
        }else{

        }
    }


    function testapi(apiid){
        if(!$.trim($("#url-"+apiid).val())){
            $("#url-"+apiid).focus();
            layer.msg("url不能为空",{offset:"200px"});
            return false;
        }
        layer.load(2,{offset:"400px"});

        var formdata = new FormData($("#newmissionform")[0])

        $.ajax({
            url:"/testapi/"+apiid,
            type:"POST",
            data:formdata,
            dataType:"JSON",
            cache:false,
            processData:false,
            contentType:false,
            error:function(request){
                layer.msg(request.status)
                layer.closeAll('loading');
            },
            success:function(data){
                layer.closeAll('loading');
                if(data.result){
                    layer.open({
                        type: 1,
                        shadeClose: true,
                        title:"测试结果",
                        shade: false,
                        maxmin: true, //开启最大化最小化按钮
                        area: ['893px', '600px'],
                        offset:"200px",
                        content: data.message
                    });
                }else{
                    layer.msg("运行失败:"+data.errorMsg,{offset:"200px"})
                }
            }
        })
    }


    function validateForm(){
        var allpass = true;

        for(var i=1;i<=parseInt(sessionStorage.apicount);i++){
            if(!$.trim($("#url-"+i).val())){
                $("#apilist-"+i).click()
                $("#url-"+i).focus();
                layer.msg("url不能为空",{offset:"200px"});
                return false;
            }
        }

        $(".required").each(function(){
            if(!$(this).val()){
                $(this).focus();
                layer.msg("请填写该值",{offset:"200px"});
                allpass = false;
            }
        })

        if(allpass && parseInt(sessionStorage.choicedMachine) == 0){
            layer.msg("请选择执行机器",{offset:"200px"})
            return false;
        }

        return allpass;
    }


    function getMachines(){
        $.ajax({
            url:"/getmachines?source=0",
            type:"get",
            error:function(request){
                layer.msg("获取机器信息失败:"+request.status)
            },
            success:function(data){
                $("#machinelistdiv").append(data);
            }
        })
    }


    function showChange(id){
        if($("#machinediv_"+id).css("background-color") == 'rgba(0, 0, 0, 0)'){
            $("#machinediv_"+id).css("background-color","#87CEFF")
            sessionStorage.choicedMachine = parseInt(sessionStorage.choicedMachine) + 1
        }else{
            $("#machinediv_"+id).css("background-color","rgba(0, 0, 0, 0)")
            sessionStorage.choicedMachine = parseInt(sessionStorage.choicedMachine) - 1
        }
    }


    function addApi(){
        layer.load(2,{offset:"400px"});
        $("#apilist > a").removeClass("active")
        sessionStorage.apicount = parseInt(sessionStorage.apicount) + 1
        $("#apilist").append('<a href="javascript:;" id="apilist-'+sessionStorage.apicount+'" class="list-group-item active" onclick="showapiconfig('+sessionStorage.apicount+')">接口_'+sessionStorage.apicount+'</a>')
        $.ajax({
            url:"/getapitemplate/" + sessionStorage.apicount,
            type:"get",
            error:function(request){
                layer.msg(request.status)
                layer.closeAll('loading');
            },
            success:function(data){
                $(".apilistitem").hide()
                $("#apilistdiv").append(data)
                layer.closeAll('loading');
            }
        })
    }


    function showapiconfig(apiid){
        $("#apilist > a").removeClass("active")
        $("#apilist-"+apiid).addClass("active")
        $(".apilistitem").hide()
        $("#apilistDetail-"+apiid).show()
    }


    function delapi(apiid){
        if(parseInt(sessionStorage.apicount) == 1){
            layer.msg("至少需要保留一个接口",{offset:"200px"})
            return
        }
        $("#apilist-"+apiid).remove()
        $("#apilistDetail-"+apiid).remove()
        sessionStorage.apicount = parseInt(sessionStorage.apicount) - 1
        $("#apilist-1").click()
    }
</script>


{% endblock %}

